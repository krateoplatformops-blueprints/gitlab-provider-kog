name: resource-blueprint-pullrequest

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  determine-changes:
    name: Determine changed charts
    runs-on: ubuntu-latest
    
    outputs:
      matrix: ${{ steps.determine-matrix.outputs.matrix }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44

      - name: Determine which charts to lint
        id: determine-matrix
        run: |
          CHARTS_TO_LINT="[]"
          # List all blueprint charts, but exclude the main 'gitlab-provider-kog-blueprint'
          ALL_CHARTS=$(ls -d gitlab-provider-kog-*-blueprint 2>/dev/null | grep -v 'gitlab-provider-kog-blueprint$')
          
          for chart in $ALL_CHARTS; do
            # Check if any of the changed files are within this chart's directory
            if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -q "$chart/"; then
              echo "Changes detected in $chart, adding to lint matrix."
              CHARTS_TO_LINT=$(echo "$CHARTS_TO_LINT" | jq -c --arg c "$chart" '. + [$c]')
            fi
          done

          echo "Charts to lint: $CHARTS_TO_LINT"
          echo "matrix={"chart":${CHARTS_TO_LINT}}" >> $GITHUB_OUTPUT

  lint-helm-charts:
    name: Lint changed Helm charts
    # Only run if the matrix from the previous job is not empty
    if: needs.determine-changes.outputs.matrix != '{"chart":[]}'
    needs: determine-changes
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.determine-changes.outputs.matrix) }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4.1.0

      - name: Resolve Placeholders for Linting
        run: |
          CHART_FILE="./${{ matrix.chart }}/Chart.yaml"
          
          # Install yq
          YQ_BIN=/usr/local/bin/yq
          sudo curl -sSL "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64" -o "${YQ_BIN}"
          sudo chmod +x "${YQ_BIN}"

          echo "Checking for placeholders in ${CHART_FILE}"
          # Replace version with a dummy value for linting
          yq e -i '.version = "0.0.0-lint"' "$CHART_FILE"
          
          # If appVersion exists, replace it too
          if [ "$(yq e 'has("appVersion")' "$CHART_FILE")" = "true" ]; then
            yq e -i '.appVersion = "0.0.0-lint"' "$CHART_FILE"
          fi

          echo "Chart.yaml for linting"
          cat "$CHART_FILE"

      - name: Lint Helm Chart
        run: |
          echo "Linting chart in directory: ./${{ matrix.chart }}"
          helm lint ./${{ matrix.chart }}
